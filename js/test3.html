
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Category Counting</title>

<style>
body { margin:0; padding: 0; font-family: 'trebuchet ms', trebuchet, verdana }
div,pre { margin:0; padding:0 }
h2 { margin: 20px 0 5px 0; padding: 0 }
p.intro { margin: 0; padding: 15px; background: #eee; font-size: small; }
.thumbs { position: absolute; width: 100px; height: 100px;}
div.thumb { position:absolute; float:left; padding: 1px; width: 64px; height: 64px;}
div.thumb img { border: 2px solid white; width:64px; height:64px; }

div#tutorial {
position:relative; 
background-color: white;  
padding: 10px;
}

</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript" language="JavaScript" src="http://web.mit.edu/esolomon/www/browserdetect.js"></script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/javascripts/jQueryRotate.2.2.js"></script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/javascripts/jQuery.mousewheel.js"></script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/javascripts/jquery.zoom-min.js"></script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/scene_parsing/scene_parsing_task8/group0.js"></script>
<script type="text/javascript" src="http://web.mit.edu/esolomon/www/zen.js"></script>
<script type="text/javascript" src="http://esolomon.scripts.mit.edu/ip.php"></script>
<script src="http://web.mit.edu/esolomon/www/javascripts/detect-zoom.js" type="text/javascript"></script>
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>

<script type="text/javascript">

shuffle = function(o) { 
	for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
	return o;
  };
  
Array.prototype.flatten = function flatten(){
   var flat = [];
   for (var i = 0, l = this.length; i < l; i++){
       var type = Object.prototype.toString.call(this[i]).split(' ').pop().split(']').shift().toLowerCase();
       if (type) { flat = flat.concat(/^(array|collection|arguments|object)$/.test(type) ? flatten.call(this[i]) : this[i]); }
   }
   return flat;
};


//!!==BEGIN DYNAMIC TRIAL CODE==!!//

function beginExp() {
	console.log('beginExp');
	$("#begintask").hide(), $("#_preload").hide();
	$('#boxes').show() 
	$('#nextTrial').show() 	
	$('.inputcount').bind('click', function(event) { event.stopPropagation() });
	$('#nextTrial').click(function(){
							   
							   trialEndTime = new Date();
							   $('#group_container').hide();
							   vals = []
							   $('.inputorder').each(function() {
							   							vals.push($(this).val())
							   									});					   
							   clicked(vals);

							   });
	
	$('#group_container').hide();
	
	//set stimuli
	showStim();
}

function init_boxes(){
   var im;
   T = $('#boxes').append('<table id="imgtable"><tr id="row1"></tr></table>')
   for (var i = 0; i < numImages; i++){
        im = new Image;
        imarray.push(im);
        $('#row1').append('<td><div><img id="image_' + String(i) + '" src="" /><input style="height:20px; width:30px;" class="inputorder" value="0" type="text" maxlength="3" id="inp2" /></div></td>')
   };
}

function setStimuli(tn){
   x = img_files[tn]; 
   console.log(x);
   for (var i = 0; i < numImages; i++){
        im = imarray[i];
        im.src = x[i];
        $('#image_' + String(i)).attr('src', im.src)
        $('.inputorder').val(0);
   };  
}

function showStim() {
	console.log('showStim');
	$('.inputcount').each(function() {$(this).val(0);});
	$('#group_container').show();
	$('#totalSeen').html('Total Objects Seen: 0');
	$('#trialCounter').html('Progress: '+trialNumber+' of '+totalTrials);
	trialStartTime = new Date();
	// set images
	setStimuli(trialNumber)	
}

function clicked(myval) {
	console.log('clicked');
 pushData(myval)

 endTrial();
	
}


function pushData(myval) {
	console.log('pushData');
StimDone.push(img_files[trialNumber]);
response.push(myval);
trialDurations.push(trialEndTime - trialStartTime);
}

function endTrial() {
  if (trialNumber >= (totalTrials-1))
  {
	var resultsobj = [];
	resultsobj.push({
					Response:response,
					ImgOrder:img_files,
					StimShown:StimDone,
					RT:trialDurations,
					Zoom:zoom,
					IPaddress:user_IP,
					Browser:BrowserDetect.browser,
					Version:BrowserDetect.version,
					OpSys:BrowserDetect.OS,
					WindowHeight:winH,
					WindowWidth:winW,
					ScreenHeight:vertical,
					ScreenWidth:horizontal
					});	  
	  
	document.getElementById("assignmentId").value = aID;
	document.getElementById("data").value = JSON.stringify(resultsobj);
	document.getElementById("postdata").submit();	
  }
    else if (jQuery.inArray(trialNumber,BreakTimes) > -1) {
	  takeABreak();
  }
  else
  {
    trialNumber++;
    showStim();
  }
}

function takeABreak() {
	$('#main_test').attr('src',breakscreen.src);
	$('.test').show()
	$('#_preload').html("<font color=red style=background-color:white>You have completed "+Math.round((trialNumber/totalTrials)*100)+"% of the experiment. Be sure to pay attention so that you know you can finish on time!");
	$('#_preload').show();
	document.onkeypress = function(e){  
			var evtobj = window.event? event : e;
			var unicode = evtobj.charCode? evtobj.charCode : evtobj.keyCode;
			var actualKey = String.fromCharCode(unicode);
				if (actualKey=='z'){
					trialNumber++;
					$('.test').hide()
					$('#_preload').hide();	
					showStim();
					};
		};
	
}

//!!==END DYNAMIC TRIAL CODE==!!//



function gup( name )
{
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var param = regex.exec( window.location.href );
  if( param == null )
    return "";
  else
    return param[1];
}

function init_vars() {
	zoom = DetectZoom.zoom();
	aID = gup("assignmentId");  
	hovertrack = new Array();
	response = new Array();
	trialDurations = new Array();
	StimDone = new Array();
	breakscreen = new Image;
	breakscreen.src = "http://s3.amazonaws.com/monkeyimgs/2way_impute/break.png";
	trialNumber = 0;
	totalTrials = 500;
	numImages = 2;
	BreakTimes = [Math.round(totalTrials/2)];
	imarray = new Array();
	img_files = [["http://s3.amazonaws.com/monkeyimgs/2way_impute/break.png",
	             "http://s3.amazonaws.com/monkeyimgs/2way_impute/break.png"]*10];
}


$(document).ready(function() {
	
	init_vars();
	init_boxes();
	
	$("#begintask").click(function(){
                                      beginExp();
                                      });

	
	$('.test').hide();
	$('#warning').hide();
    $('#boxes').hide() 
	$('#nextTrial').hide() 	

	$("#tutorial").html($("#tutorial_original").html());
	$("#tutorial").dialog({height:700,
							width:600,
							position:"center",
							title:"Instructions"
							});
							
	if (aID == "ASSIGNMENT_ID_NOT_AVAILABLE"){
	$('#warning').show();
	$('#warning').html("<font color=red style=background-color:white><b>You are in PREVIEW mode. Please ACCEPT this HIT to complete the task and receive payment.</b></font>")
	}
	
});

</script>

</head>

<body bgcolor="#7F7F7F">
<div align="center" id="warning"></div>
<div align="center"><button id="begintask" value="Begin!">Begin!</button></div></div>
<div id="_preload" align="center" style="position:fixed; top:0px; left:10px;"></div>
<div class="test" align="center" style="position:relative; z-index:200; top:125px; left:-15px;"><img id="main_test" src="" /></div>
<div id="group_container" align="center">
<div id="trialCounter"></div>

<div id="boxes"></div>
<button style="height:50px;" id="nextTrial">Go To Next Trial</button>
</div>

<div id="tutorial_link" style="position:fixed; top:0px; right:10px;" onclick="$('#tutorial').html($('#tutorial_original').html()); $('#tutorial').dialog({height:700,							width:600,position:'center',title:'Instructions'})"><u>View Instructions</u></div>

<div id="tutorial" style="position:relative; z-index:-1"></div>
<div id="tutorial_original" style="position:absolute; z-index:-1; visibility:hidden;" Tut p1.
<center><p onclick="$('#tutorial').html($('#tutorial2').html())"><font color=blue><u>Click here to continue reading</u></font></p></center></div>
<div id="tutorial2" style="visibility:hidden; position:absolute; z-index:-1;"> Tut p2.
<center><p onclick="$('#tutorial').html($('#tutorial3').html())"><font color=blue><u>Click here to continue reading</u></font></p></center>
</div>
<div id="tutorial3" style="visibility:hidden; position:absolute; z-index:-1;"> Tut p3.
<center><font color=blue><u><p onclick="$('#tutorial').dialog('close')">Click here to close the instructions</p></center></font></u>
</div>



</body>
</html>
